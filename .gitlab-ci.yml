stages:
  - build
  - deploy

# ================================
# BUILD ‚Äî Generate dist_xxx.tar.gz
# ================================
build_job:
  stage: build
  image: node:20
  script:
    - npm ci
    - npm run build

    # Create TAR with timestamp
    - TS=$(date +%s)
    - TAR="dist_$TS.tar.gz"
    - tar -czf $TAR -C dist .

    # Simpan nama TAR untuk job deploy
    - echo $TAR > TAR_NAME

  artifacts:
    paths:
      - dist_*.tar.gz
      - TAR_NAME


# ==================================
# DEPLOY ‚Äî Upload TAR ‚Üí VPS ‚Üí VM
# ==================================
deploy_job:
  stage: deploy
  image: alpine:latest

  before_script:
    - apk add --no-cache openssh-client bash

    # --- Setup SSH folder ---
    - mkdir -p ~/.ssh

    # --- Decode Base64 ‚Üí Private Key ---
    - echo "$SSH_PRIVATE_KEY_BASE64" | base64 -d > ~/.ssh/id_ed25519
    - chmod 600 ~/.ssh/id_ed25519

    # --- Add known hosts (VPS + VM) ---
    - ssh-keyscan -H "$VPS_HOST" >> ~/.ssh/known_hosts
    - ssh-keyscan -H "$VM_HOST" >> ~/.ssh/known_hosts

  script:
    # Baca nama file TAR dari artifact
    - TAR=$(cat TAR_NAME)

    # ===========================
    # 1Ô∏è‚É£ Upload TAR ke VPS
    # ===========================
    - echo "üì§ Upload TAR to VPS: $TAR"
    - scp -o StrictHostKeyChecking=no $TAR $VPS_USER@$VPS_HOST:/root/

    # ===========================
    # 2Ô∏è‚É£ Dari VPS ‚Üí VM (WireGuard)
    # ===========================
    - echo "üì° VPS forwarding TAR to VM..."
    - ssh -o StrictHostKeyChecking=no $VPS_USER@$VPS_HOST "scp /root/$TAR $VM_USER@$VM_HOST:/root/"

    # ===========================
    # 3Ô∏è‚É£ Run deploy script dalam VM
    # ===========================
    - echo "üöÄ Trigger deploy inside VM..."
    - ssh -o StrictHostKeyChecking=no $VPS_USER@$VPS_HOST \
        "ssh $VM_USER@$VM_HOST 'bash /root/deploy_swap.sh /root/$TAR'"

  only:
    - main
